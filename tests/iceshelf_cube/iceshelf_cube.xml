<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE testproblem SYSTEM "regressiontest.dtd">

<testproblem>
  <name>iceshelf_cube</name>
  <owner userid="skimura"/>
  <tags>flml iceshelf</tags>
  <problem_definition length="short" nprocs="1">
    <command_line>fluidity -v3 -l shelf3d.flml</command_line>
  </problem_definition>
  <variables>
    <variable name="R2_GadeLine" language="python">
import vtktools
from numpy import mean, sum

def Gade_line(Sg1,T1,S1):
    c0=3974.0
    cI=2009.0
    L=3.35e5
    Li=L
    TI=-25
    a=-0.0573
    b=0.0832
    Cd = 1.5e-3
    Tf=a*S1+b
    dTdS1 = ((T1-Tf)+Li/c0+(cI/c0)*(Tf-TI)) /(S1-0)
    Tg1 = dTdS1*(Sg1-S1) +T1
    return Tg1
    
fname_a = "shelf3d_2.vtu"
datafile = vtktools.vtu(fname_a)
T=datafile.GetScalarField("Temperature")
S=datafile.GetScalarField("Salinity")

###Construct Gade line, need the first time
T1=0.0
S1=35.0

S_gade=S
T_gade=Gade_line(S_gade,T1,S1)

#Compare T_gade and T_1
#Calculate R2 = 
T_bar = mean(T)
SS_tot = sum((T-T_bar)**2)
SS_err = sum((T_gade-T)**2)
R2_GadeLine = 1-(SS_err)/(SS_tot)
    </variable>
  </variables>
  <pass_tests>
    <test name="Checking R2 is larger than 0.98" language="python">
assert R2_GadeLine > 0.98
    </test>
  </pass_tests>
  <warn_tests>
  </warn_tests>
</testproblem>
