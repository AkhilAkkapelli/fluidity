<?xml version='1.0' encoding='utf-8'?>
<testproblem>
  <name>wetting_and_drying_optimum_aspect_ratio_channel</name>
  <owner userid="asc"/>
  <tags>flml wetdry wetdryaspectratio</tags>
  <problem_definition length="short" nprocs="1">
    <command_line>
for folder in 1 2 3 4 5; do cd ${folder}; fluidity -l -v3 channel.flml; cd ..; done
    </command_line>
  </problem_definition>
  <variables>
    <variable name="tolerance" language="python">
      tolerance = 1e-4
    </variable>
    <variable name="solvers_converged" language="python">
import os
solvers_converged = []
for folder in range(5): 
  files = os.listdir(str(folder + 1))
  solvers_converged.append(not "matrixdump" in files and not "matrixdump.info" in files)
    </variable>
    <variable name="ElapsedTime" language="python">from fluidity_tools import stat_parser
ElapsedTime = []
for folder in range(5): 
  s = stat_parser(str(folder + 1) + '/channel.stat')
  ElapsedTime.append(s["ElapsedTime"]["value"][-1])</variable>
    <variable name="pressure_iterations" language="python">
    from pressure_iterations_maximum import find_iterations_pressure
pressure_iterations = []
for folder in range(5): 
  p = find_iterations_pressure(str(folder + 1) + '/fluidity.log-0')
  p['run'] = folder
  pressure_iterations.append(p)
print 'Pressure iterations summary:'
for p in pressure_iterations:
  print '  Run %(run)i: %(entries)i solves with maximum %(maximum)i and average %(average)i' % p
    </variable>
  </variables>
  <pass_tests>
    <test name="Solvers converged" language="python">
      assert(all(solvers_converged))
    </test>
    <test name="endtime" language="python">
      assert(all(t >= 1.0 for t in ElapsedTime))
    </test>
    <test name="Pressure solves" language="python">
      assert(all(pressure_iterations[i]['entries'] == 2 for i in range(5)))
    </test>
    <test name="Pressure_iterations_max_a_0.01" language="python">
      assert(  abs(pressure_iterations[0]['maximum'] - 259) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_max_a_0.1" language="python">
      assert(  abs(pressure_iterations[1]['maximum'] - 154) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_max_a_1" language="python">
      assert(  abs(pressure_iterations[2]['maximum'] - 38) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_max_a_10" language="python">
      assert(  abs(pressure_iterations[3]['maximum'] - 65) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_max_a_100" language="python">
      assert(  abs(pressure_iterations[4]['maximum'] - 109) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_mean_a_0.01" language="python">
      assert(  abs(pressure_iterations[0]['average'] - 257) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_mean_a_0.1" language="python">
      assert(  abs(pressure_iterations[1]['average'] - 146) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_mean_a_1" language="python">
      assert(  abs(pressure_iterations[2]['average'] - 37) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_mean_a_10" language="python">
      assert(  abs(pressure_iterations[3]['average'] - 64) &lt; tolerance )
    </test>
    <test name="Pressure_iterations_mean_a_100" language="python">
      assert(  abs(pressure_iterations[4]['average'] - 107) &lt; tolerance )
    </test>
  </pass_tests>
</testproblem>
